# Руководство пользователя Lavsit Textile

## Содержание

1. [Общее описание системы](#общее-описание-системы)
2. [Основные функции](#основные-функции)
3. [Работа с поставщиками](#работа-с-поставщиками)
4. [Работа с тканями](#работа-с-тканями)
5. [Правила парсинга для каждого поставщика](#правила-парсинга-для-каждого-поставщика)
6. [Управление категориями](#управление-категориями)
7. [Исключения из парсинга](#исключения-из-парсинга)
8. [Ручная загрузка данных](#ручная-загрузка-данных)
9. [Email интеграция](#email-интеграция)
10. [Экспорт данных](#экспорт-данных)

---

## Общее описание системы

**Lavsit Textile** — это система для автоматического парсинга, хранения и управления данными о тканях от различных поставщиков. Система позволяет:

- Автоматически получать данные о наличии тканей от поставщиков
- Парсить прайс-листы для установки цен
- Управлять категориями тканей
- Фильтровать и сортировать ткани по различным параметрам
- Редактировать данные вручную
- Исключать ткани из автоматического парсинга
- Экспортировать данные

---

## Основные функции

### Главная страница (`/fabrics`)

Главная страница отображает все ткани в виде таблицы с возможностью:

#### Отображение данных

- **Поставщик** — название поставщика ткани
- **Коллекция** — название коллекции ткани
- **Цвет** — номер/название цвета
- **Наличие** — статус наличия (в наличии / нет в наличии)
- **Метраж** — количество метров в наличии
- **Цена** — цена ткани (можно редактировать)
- **Категория** — категория ткани (1-16, определяется автоматически по цене)
- **Тип ткани** — тип ткани (можно редактировать)
- **Описание** — описание ткани (можно редактировать, раскрывается по клику)
- **Изображение** — кнопка для загрузки изображения ткани
- **Дата обновления** — дата последнего обновления данных
- **Дата поступления** — дата следующего поступления (если указана)
- **Комментарий** — дополнительные комментарии

#### Группировка по коллекциям

Ткани автоматически группируются по коллекциям. Для каждой коллекции отображается заголовок с названием коллекции и кнопкой "Свернуть/Развернуть категорию".

#### Фильтрация и поиск

- **Поиск** — поиск по названию коллекции или цвета
- **Фильтр по поставщику** — выбор конкретного поставщика
- **Показывать только в наличии** — фильтр для отображения только тканей в наличии
- **Фильтр по типу ткани** — выпадающий список с множественным выбором
- **Фильтр по категории** — выбор категории ткани

#### Счетчики

В верхней части страницы отображаются динамические счетчики:
- **Общее количество тканей** — количество тканей с учетом активных фильтров
- **Общее количество коллекций** — количество коллекций с учетом фильтров
- **Общее количество поставщиков** — количество поставщиков с учетом фильтров

#### Сортировка

Клик по заголовку колонки позволяет сортировать данные по:
- Поставщику
- Коллекции
- Цвету
- Наличию
- Метражу
- Цене
- Категории

#### Редактирование данных

##### Редактирование отдельной ткани

- **Цена** — клик по цене открывает поле для редактирования
- **Тип ткани** — клик по типу ткани открывает поле для редактирования
- **Описание** — клик по описанию открывает поле для редактирования (раскрывается по клику)

После ввода данных нажмите кнопку "Сохранить" или клавишу Enter. Данные сохраняются и остаются до тех пор, пока их не перезапишет автоматический парсер.

##### Редактирование коллекции

Клик по названию коллекции (в заголовке или в любой строке) открывает диалоговое окно с полями:
- **Тип ткани** — тип ткани для всей коллекции
- **Категория ткани** — категория для всей коллекции
- **Цена ткани** — цена для всей коллекции
- **Описание ткани** — описание для всей коллекции

После сохранения появляется диалог с вопросом: "Применить описание ко всем цветам данной коллекции?"
- **Да** — все введенные данные применяются ко всем цветам в коллекции
- **Нет** — изменяется только описание коллекции

#### Удаление и исключения

Кнопка "X" справа от названия коллекции или цвета позволяет:
- **Удалить из текущей выборки** — удаляет ткань/коллекцию из текущего отображения (данные остаются в базе)
- **Сделать исключением для парсинга** — исключает ткань/коллекцию из автоматического парсинга (при следующем парсинге данные не будут обновляться)

---

## Работа с поставщиками

### Страница поставщиков (`/suppliers`)

Страница отображает таблицу всех поставщиков с информацией:
- Название поставщика
- Метод парсинга (HTML, Excel, Email)
- Количество тканей
- Дата последнего обновления
- Статус (активен / ошибка)

#### Действия с поставщиком

- **Анализ** — анализ структуры данных (выполняется при первом добавлении поставщика)
- **Парсинг** — запуск парсинга данных о тканях
- **Настройки Email** — настройка email для email-поставщиков
- **Проверить Email** — проверка email и парсинг вложений (для email-поставщиков)
- **Ручная загрузка наличия** — загрузка файла с данными о наличии
- **Ручная загрузка прайс-листа** — загрузка прайс-листа для установки цен
- **Правила** — просмотр и редактирование правил парсинга
- **Экспорт** — экспорт данных поставщика в Excel
- **Исключения парсинга** — переход на страницу управления исключениями

#### Обновление всех данных

Кнопка "Обновить все данные" запускает одновременный парсинг для всех поставщиков.

---

## Работа с тканями

### Просмотр тканей

Все ткани отображаются на главной странице с возможностью фильтрации, сортировки и группировки по коллекциям.

### Редактирование тканей

См. раздел [Редактирование данных](#редактирование-данных) выше.

### Загрузка изображений

Кнопка "Добавить изображение" позволяет загрузить изображение ткани. Изображение сохраняется и отображается в таблице.

---

## Правила парсинга для каждого поставщика

### Аметист

**Метод парсинга:** Email (Excel вложения)

**Правила парсинга тканей:**

1. **Коллекция** — столбец C (индекс 2)
2. **Цвет** — столбец E (индекс 4)
3. **Метраж** — столбец G (индекс 6)
   - Значение берется только из ячейки столбца G
   - Поддерживаются не целые числа (например, 76,4 или 76.4)
   - Могут быть знаки больше/меньше (например, > 100, < 8)
   - Если число >= 10: `в наличии = true`, метраж = число
   - Если число < 10: `в наличии = true`, метраж = число, комментарий = "ВНИМАНИЕ, МАЛО!"
4. **Дата следующего поступления** — столбец J (индекс 9)

**Особенности:**
- Файлы могут приходить в формате ZIP, система автоматически распаковывает Excel файл
- Единица измерения "м" может быть в следующей колонке (H) или в той же ячейке

**Правила парсинга прайса:**
- Прайс-листы не парсятся автоматически (используется ручная загрузка)

---

### NoFrames

**Метод парсинга:** Excel по URL

**Правила парсинга тканей:**

1. **Коллекция и цвет** — столбец B (индекс 1)
   - Формат: "КОЛЛЕКЦИЯ ЦВЕТ" (разделены пробелом)
2. **Наличие** — столбец D (индекс 3)
   - Если значение > 0: `в наличии = true`, метраж = значение
   - Если значение = 0 или пусто: `в наличии = false`
3. **Дата следующего поступления** — столбец E (индекс 4)

**Особенности:**
- Парсятся только вкладки "ОСНОВНЫЕ КОЛЛЕКЦИИ" и "РАСПРОДАЖА"
- Пропускаются первые 6 строк (заголовки)
- Игнорируются строки, содержащие только название коллекции (без цвета)

**Правила парсинга прайса:**

1. **Коллекция** — столбец B (индекс 1)
2. **Цена** — столбец E (индекс 4)
   - Формат: "3 171,00р." (пробелы как разделители тысяч, запятая как десятичный разделитель)
   - Нормализуется до: 3171.00 ₽
3. **Тип ткани** — столбец G (индекс 6)
   - Присваивается всем тканям в коллекции
4. **Описание** — формируется из:
   - Столбец F (индекс 5) — страна
   - Столбец H (индекс 7) — состав
   - Столбец I (индекс 8) — тест Мартиндейла
   - Формат: "Страна: {F}, Состав: {H}, тест Мартиндейла: {I}"
5. **Категория** — определяется автоматически по цене за метр погонный

**Особенности:**
- Цена одинакова для всех тканей в коллекции
- После нахождения цены коллекции она применяется ко всем тканям в этой коллекции
- Категория определяется автоматически после установки цены

---

### Эгида

**Метод парсинга:** Excel по URL (динамический)

**Правила парсинга тканей:**

1. **Коллекция и цвет** — столбец B (индекс 1)
   - Коллекция — текст до первой цифры
   - Цвет — цифры + текст после
2. **Наличие** — столбец C (индекс 2)
   - "Есть в наличии" → `в наличии = true`
   - "Мало" → `в наличии = true`, комментарий = "ВНИМАНИЕ, МАЛО!"
   - "Нет в наличии" → `в наличии = false`
3. **Комментарий** — столбец D (индекс 3)
   - Если заполнен, добавляется к комментарию с префиксом "На складе в Казани: {текст}"
4. **Дата следующего поступления** — столбец E (индекс 4)

**Особенности:**
- URL динамический: `https://exch.tendence.ru/download.php?file={DD.MM.YY}_ostatki_tkani_ooo_egida.xls`
- Система автоматически ищет актуальный файл, проверяя даты от сегодня до 30 дней назад

**Правила парсинга прайса:**
- Прайс-листы не парсятся автоматически (используется ручная загрузка)

---

### Нортекс

**Метод парсинга:** Email (Excel вложения)

**Правила парсинга тканей:**

1. **Коллекция и цвет** — столбец D (индекс 3)
   - Формат: "Ткань {КОЛЛЕКЦИЯ} {ЦВЕТ}"
   - Префикс "Ткань" автоматически удаляется
2. **Наличие** — столбцы E, F, G (индексы 4, 5, 6)
   - Если значение в столбце G > 100м: `в наличии = true`, метраж = значение из G
   - Если значение в столбце F < 100м: `в наличии = true`, метраж = значение из F
   - Если значение в столбце E: `в наличии = true`, метраж = значение из E
3. **Дата следующего поступления** — столбец H (индекс 7)

**Особенности:**
- Пропускаются строки с "пог. м", "Ед.изм.", "отчет создан"
- Данные приходят по email в виде Excel вложений

**Правила парсинга прайса:**
- Прайс-листы не парсятся автоматически (используется ручная загрузка)

---

### Vektor

**Метод парсинга:** Excel по URL (динамический)

**Правила парсинга тканей:**

1. **Коллекция и цвет** — столбец D (индекс 3)
   - Формат: "КОЛЛЕКЦИЯ ЦВЕТ"
2. **Метраж** — столбец F (индекс 5)
   - Если значение > 0: `в наличии = true`, метраж = значение
   - Если значение = 0 или пусто: `в наличии = false`
3. **Дата следующего поступления** — столбец G (индекс 6)

**Особенности:**
- URL динамический: `https://api.vektor.club/static/remainders_files/{DDMMYY}_MSK.xlsx`
- Система автоматически ищет актуальный файл
- Игнорируются строки со словом "Сетка"

**Правила парсинга прайса:**
- Прайс-листы не парсятся автоматически (используется ручная загрузка)

---

### Viptextil

**Метод парсинга:** HTML

**Правила парсинга тканей:**

1. **Коллекция и цвет** — столбец A (индекс 0)
   - Формат: "КОЛЛЕКЦИЯ ЦВЕТ"
2. **Наличие** — столбец B (индекс 1)
   - "Есть в наличии" → `в наличии = true`
   - Другие значения → `в наличии = false`, комментарий = значение из столбца B

**Особенности:**
- Парсинг HTML страницы через Puppeteer (для обхода защиты от ботов)
- Fallback на curl, если Puppeteer не работает

**Правила парсинга прайса:**
- Прайс-листы не парсятся автоматически (используется ручная загрузка)

---

### Artefact

**Метод парсинга:** Excel по URL

**Правила парсинга тканей:**

1. **Коллекция и цвет** — столбец A (индекс 0)
   - Формат: "КОЛЛЕКЦИЯ ЦВЕТ"
2. **Метраж** — столбец C (индекс 2)
   - Если значение > 0: `в наличии = true`, метраж = значение
   - Если значение < 10: комментарий = "ВНИМАНИЕ, МАЛО!"
   - Если "нет" или пусто: `в наличии = false`
3. **Комментарий** — столбец D (индекс 3)
4. **Дата следующего поступления** — столбец F (индекс 5)

**Правила парсинга прайса:**
- Прайс-листы не парсятся автоматически (используется ручная загрузка)

---

### Artvision

**Метод парсинга:** HTML

**Правила парсинга тканей:**

1. **Коллекция и цвет** — столбец A (индекс 0)
   - Разделение по тире: "КОЛЛЕКЦИЯ - ЦВЕТ"
2. **Наличие** — столбец B (индекс 1)
3. **Метраж** — столбец C (индекс 2)

**Правила парсинга прайса:**
- Прайс-листы не парсятся автоматически (используется ручная загрузка)

---

### Союз-М

**Метод парсинга:** Excel по URL

**Правила парсинга тканей:**

1. **Коллекция и цвет** — столбец B (индекс 1)
2. **Наличие** — столбец C (индекс 2)

**Правила парсинга прайса:**
- Прайс-листы не парсятся автоматически (используется ручная загрузка)

---

### Домиарт

**Метод парсинга:** Excel по URL

**Правила парсинга тканей:**

1. **Коллекция и цвет** — столбец A (индекс 0)
2. **Специальное правило:** для коллекции "Alfa 2303" применяется особая логика парсинга

**Правила парсинга прайса:**
- Прайс-листы не парсятся автоматически (используется ручная загрузка)

---

### Артекс

**Метод парсинга:** Excel по URL

**Правила парсинга тканей:**

1. **Коллекция и цвет** — столбец A (индекс 0)
   - Удаляется префикс "Мебельная ткань"

**Правила парсинга прайса:**
- Прайс-листы не парсятся автоматически (используется ручная загрузка)

---

### TextileData

**Метод парсинга:** HTML

**Правила парсинга тканей:**

1. **Коллекция и цвет** — столбец A (индекс 0)
   - Удаляется "_\" и извлекаются только цифры для цвета

**Правила парсинга прайса:**
- Прайс-листы не парсятся автоматически (используется ручная загрузка)

---

### TextileNova

**Метод парсинга:** HTML

**Правила парсинга тканей:**

1. Парсинг HTML таблицы с данными о тканях

**Правила парсинга прайса:**
- Прайс-листы не парсятся автоматически (используется ручная загрузка)

---

### Tex.Group

**Метод парсинга:** Excel по URL

**Правила парсинга тканей:**

1. Парсинг Excel файла с данными о тканях

**Правила парсинга прайса:**
- Прайс-листы не парсятся автоматически (используется ручная загрузка)

---

## Управление категориями

### Страница категорий (`/categories`)

Страница позволяет управлять категориями тканей:

- **Просмотр категорий** — таблица с номером категории и ценой
- **Добавление категории** — добавление новой категории
- **Редактирование категории** — изменение цены категории
- **Удаление категории** — удаление категории

### Логика категоризации

Категория определяется автоматически по цене за метр погонный:
- Если цена <= цене категории → присваивается эта категория
- Если цена больше всех категорий → присваивается максимальная категория (16)

**Категории по умолчанию:**
1. 550 руб.
2. 650 руб.
3. 800 руб.
4. 1000 руб.
5. 1250 руб.
6. 1550 руб.
7. 1900 руб.
8. 2300 руб.
9. 2750 руб.
10. 3250 руб.
11. 3800 руб.
12. 4400 руб.
13. 5050 руб.
14. 5750 руб.
15. 6500 руб.
16. 7300 руб.

---

## Исключения из парсинга

### Страница исключений (`/exclusions`)

Страница отображает все ткани и коллекции, исключенные из автоматического парсинга.

**Структура:**
- Поставщик
  - Коллекция
    - Цвет (чекбокс)

**Действия:**
- Снять чекбокс с ткани/коллекции и нажать "Сохранить" → ткань/коллекция снова будет парситься автоматически

---

## Ручная загрузка данных

### Ручная загрузка наличия

Позволяет загрузить файл с данными о наличии тканей. Загруженные данные имеют приоритет над автоматическим парсером до тех пор, пока парсер не получит более новые данные.

### Ручная загрузка прайс-листа

Позволяет загрузить прайс-лист для установки цен. Система анализирует файл и устанавливает цены для тканей по коллекции и цвету.

**Особенности:**
- Для NoFrames: автоматически определяется тип ткани и описание из прайс-листа
- Цены применяются ко всем тканям в коллекции
- Категория определяется автоматически после установки цены

---

## Email интеграция

### Настройка email

Для email-поставщиков (Аметист, Нортекс) необходимо настроить:

1. **IMAP хост** — адрес IMAP сервера (например, imap.gmail.com)
2. **Порт** — порт IMAP (обычно 993 для SSL)
3. **Безопасное соединение** — использовать SSL/TLS
4. **Пользователь** — имя пользователя email
5. **Пароль** — пароль (для Gmail/Mail.ru нужен App Password)
6. **Отправитель** — фильтр по отправителю (опционально)
7. **Фильтр по теме** — фильтр по теме письма (опционально)
8. **Период поиска** — количество дней для поиска (по умолчанию 90)
9. **Только непрочитанные** — искать только непрочитанные письма (по умолчанию false)

### Проверка email

Кнопка "Проверить Email" позволяет:
- Подключиться к почтовому серверу
- Найти письма с Excel вложениями
- Сохранить вложения на диск
- Запустить парсинг сохраненных файлов

---

## Экспорт данных

### Экспорт данных поставщика

Кнопка "Экспорт" на странице поставщиков позволяет экспортировать все данные поставщика в Excel файл.

**Экспортируемые данные:**
- Коллекция
- Цвет
- Наличие
- Метраж
- Цена
- Категория
- Тип ткани
- Описание
- Дата обновления
- Дата поступления
- Комментарий

---

## Технические детали

### База данных

Система использует SQLite базу данных (файл `prisma/dev.db`).

### Хранение файлов

- **Ручные загрузки:** `data/manual-uploads/{supplierId}/`
- **Email вложения:** `data/email-attachments/{supplierId}/`
- **Распарсенные данные:** `data/parsed/`
- **Изображения тканей:** `public/images/fabrics/{supplierId}/`

### Правила парсинга

Правила парсинга хранятся в базе данных в таблице `ParsingRule` в формате JSON.

### Структура данных

Структура данных поставщика хранится в таблице `DataStructure` и используется для обнаружения изменений в формате данных.

---

## Решение проблем

### Парсер не находит данные

1. Проверьте правила парсинга (кнопка "Правила" на странице поставщика)
2. Проверьте структуру данных (может измениться формат файла)
3. Запустите анализ структуры данных заново

### Email не работает

1. Проверьте настройки email (кнопка "Настройки Email")
2. Убедитесь, что используется App Password для Gmail/Mail.ru
3. Проверьте фильтры по отправителю и теме
4. Увеличьте период поиска

### Данные не обновляются

1. Проверьте, не исключена ли ткань из парсинга (страница "Исключения парсинга")
2. Проверьте, не блокирует ли ручная загрузка обновления
3. Запустите парсинг вручную

### Категория не определяется

1. Убедитесь, что указана цена ткани
2. Убедитесь, что указан метраж (для расчета цены за метр)
3. Проверьте категории в базе данных (страница "Категории")

---

## Поддержка

При возникновении проблем:
1. Проверьте логи в консоли браузера (F12)
2. Проверьте логи сервера
3. Проверьте состояние базы данных через Prisma Studio (`npm run db:studio`)

