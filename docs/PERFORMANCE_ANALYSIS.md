# Анализ производительности Lavsit Textile

## Дата анализа: 2025-01-28

## Текущее состояние

### Главная страница (`/fabrics`)

#### Загрузка данных

**Текущая реализация:**
- Запрос всех тканей через `/api/fabrics`
- Фильтрация исключенных тканей на уровне БД (`excludedFromParsing = false`)
- Вычисление `pricePerMeter` и `category` для каждой ткани на сервере
- Сортировка на сервере (по поставщику, коллекции, цвету)

**Проблемы:**
1. Вычисление `pricePerMeter` и `category` для каждой ткани выполняется на сервере при каждом запросе
2. Нет кэширования результатов
3. Нет пагинации (загружаются все ткани сразу)
4. Фильтрация и сортировка на клиенте (после загрузки всех данных)

#### Оптимизации на клиенте

**Текущая реализация:**
- Использование `useMemo` для фильтрации и сортировки
- Группировка по коллекциям в памяти
- Мемоизация счетчиков

**Проблемы:**
1. Все данные загружаются сразу (нет виртуализации)
2. Нет ленивой загрузки изображений
3. Редактирование данных вызывает перезагрузку всех данных

### API Endpoints

#### `/api/fabrics`

**Текущая реализация:**
- Запрос всех тканей из БД
- Вычисление `pricePerMeter` и `category` для каждой ткани
- Fallback на raw SQL при ошибках Prisma

**Проблемы:**
1. Нет кэширования результатов
2. Вычисления выполняются при каждом запросе
3. Нет пагинации

#### `/api/suppliers`

**Текущая реализация:**
- Простой запрос всех поставщиков
- Подсчет количества тканей для каждого поставщика

**Проблемы:**
1. Подсчет тканей выполняется при каждом запросе (можно кэшировать в `fabricsCount`)

### База данных

#### Индексы

**Текущие индексы:**
- `Fabric.supplierId`
- `Fabric.collection`
- `Fabric.lastUpdatedAt`
- `Fabric.category`
- `Fabric.excludedFromParsing`

**Рекомендации:**
1. Добавить составной индекс `(supplierId, collection, colorNumber)` для быстрого поиска
2. Добавить индекс `(inStock, excludedFromParsing)` для фильтрации
3. Рассмотреть индексы для часто используемых фильтров

#### Запросы

**Проблемы:**
1. Нет использования `select` для ограничения полей (загружаются все поля)
2. Нет пагинации
3. Вычисления выполняются в JavaScript, а не в SQL

## Рекомендации по оптимизации

### 1. Кэширование на сервере

**Приоритет: Высокий**

- Кэшировать результаты `/api/fabrics` на 1-5 минут
- Использовать Redis или in-memory кэш
- Инвалидировать кэш при обновлении данных

### 2. Вычисления в БД

**Приоритет: Высокий**

- Вычислять `pricePerMeter` и `category` в SQL запросе
- Использовать SQL функции для вычислений
- Создать материализованное представление или триггеры

### 3. Пагинация

**Приоритет: Средний**

- Добавить пагинацию на сервере (limit/offset)
- Реализовать бесконечную прокрутку или постраничную навигацию
- Загружать данные порциями по 50-100 записей

### 4. Виртуализация списка

**Приоритет: Средний**

- Использовать `react-window` или `react-virtual` для виртуализации таблицы
- Рендерить только видимые строки
- Уменьшить количество DOM элементов

### 5. Ленивая загрузка изображений

**Приоритет: Низкий**

- Использовать `loading="lazy"` для изображений
- Загружать изображения только при прокрутке к ним

### 6. Оптимизация запросов

**Приоритет: Высокий**

- Использовать `select` для загрузки только нужных полей
- Добавить составные индексы
- Оптимизировать JOIN запросы

### 7. Мемоизация на клиенте

**Приоритет: Средний**

- Улучшить использование `useMemo` и `useCallback`
- Мемоизировать тяжелые вычисления
- Избежать ненужных ре-рендеров

### 8. Оптимизация обновлений

**Приоритет: Средний**

- Обновлять только измененные данные, а не перезагружать все
- Использовать оптимистичные обновления
- Batch обновления при редактировании

## План реализации

### Фаза 1: Критичные оптимизации (1-2 дня)

1. ✅ Добавить составные индексы в БД
2. ✅ Вычислять `pricePerMeter` и `category` в SQL
3. ✅ Использовать `select` для ограничения полей
4. ✅ Добавить базовое кэширование на сервере

### Фаза 2: Улучшение UX (2-3 дня)

1. ✅ Добавить пагинацию
2. ✅ Реализовать виртуализацию списка
3. ✅ Оптимизировать обновления данных

### Фаза 3: Дополнительные оптимизации (1-2 дня)

1. ✅ Ленивая загрузка изображений
2. ✅ Улучшение мемоизации
3. ✅ Оптимизация запросов к БД

## Метрики производительности

### Текущие метрики (нужно измерить)

- Время загрузки главной страницы: ?
- Время выполнения `/api/fabrics`: ?
- Размер ответа API: ?
- Количество запросов к БД: ?

### Целевые метрики

- Время загрузки главной страницы: < 1 сек
- Время выполнения `/api/fabrics`: < 500 мс
- Размер ответа API: < 1 MB (с пагинацией)
- Количество запросов к БД: 1-2 запроса на страницу

## Инструменты для мониторинга

1. **Next.js Analytics** — для мониторинга производительности страниц
2. **Prisma Query Logging** — для мониторинга запросов к БД
3. **Chrome DevTools Performance** — для анализа производительности клиента
4. **Lighthouse** — для аудита производительности


