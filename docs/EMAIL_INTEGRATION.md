# Интеграция поставщиков с Email-рассылкой Excel

## Обзор

Система поддерживает автоматическую обработку поставщиков, которые присылают остатки тканей в Excel файлах по электронной почте.

## Архитектура

1. **Email Parser** (`lib/email/email-parser.ts`) - подключается к IMAP серверу и извлекает вложения
2. **Email Excel Parser** (`lib/parsers/email-excel-parser.ts`) - парсит Excel файлы из email
3. **API Endpoints** - для ручного запуска проверки и настройки
4. **Scheduled Job** (`lib/jobs/email-checker.ts`) - автоматическая проверка email

## Настройка поставщика

### 1. Создание поставщика с типом "email"

1. Перейдите на страницу "Поставщики"
2. Найдите поставщика или создайте нового
3. Нажмите "Настройки Email" для поставщика с типом "email"

### 2. Конфигурация Email

В форме настройки укажите:

- **IMAP сервер**: адрес IMAP сервера (например, `imap.gmail.com`)
- **Порт**: обычно 993 для SSL/TLS
- **Безопасное соединение**: включите для SSL/TLS
- **Email адрес**: адрес для подключения к почтовому ящику
- **Пароль**: пароль или App Password (для Gmail)
- **Email отправителя** (опционально): фильтр по адресу отправителя
- **Фильтр по теме** (опционально): фильтр по теме письма

### 3. Быстрая настройка для популярных провайдеров

Используйте кнопки быстрой настройки:
- **Gmail**: `imap.gmail.com:993` (SSL)
- **Яндекс**: `imap.yandex.ru:993` (SSL)
- **Mail.ru**: `imap.mail.ru:993` (SSL)
- **Outlook**: `outlook.office365.com:993` (SSL)

### 4. Gmail App Password

Для Gmail необходимо использовать App Password вместо обычного пароля:

1. Перейдите в настройки Google аккаунта
2. Включите двухфакторную аутентификацию
3. Создайте App Password для "Почта"
4. Используйте этот пароль в настройках

## Использование

### Ручная проверка Email

1. На странице "Поставщики" найдите поставщика с типом "email"
2. Нажмите кнопку "Проверить Email"
3. Система подключится к почтовому ящику, найдет новые письма с Excel вложениями
4. Вложения будут сохранены и обработаны автоматически

### Автоматическая проверка

Для автоматической проверки email используйте один из вариантов:

#### Вариант 1: API Endpoint (рекомендуется)

Создайте cron job, который будет вызывать:
```
POST /api/jobs/check-emails
Authorization: Bearer YOUR_API_KEY
```

Настройте переменную окружения:
```
EMAIL_CHECKER_API_KEY=your-secret-key
```

#### Вариант 2: Внешний cron сервис

Используйте сервисы типа:
- cron-job.org
- EasyCron
- GitHub Actions (для репозиториев)

Настройте вызов `POST /api/jobs/check-emails` каждые 30-60 минут.

## Процесс обработки

1. **Подключение к email** - система подключается к IMAP серверу
2. **Поиск писем** - ищет непрочитанные письма за последние 7 дней
3. **Фильтрация** - применяет фильтры по отправителю и теме (если настроены)
4. **Извлечение вложений** - находит Excel файлы (.xls, .xlsx)
5. **Сохранение** - сохраняет файлы во временное хранилище
6. **Анализ** - автоматически анализирует структуру файла (если правила не установлены)
7. **Парсинг** - извлекает данные о тканях
8. **Обновление БД** - обновляет данные в базе данных
9. **Маркировка** - помечает вложения как обработанные

## Безопасность

- Email пароли хранятся в базе данных в зашифрованном виде (рекомендуется использовать переменные окружения)
- API endpoint для автоматической проверки защищен API ключом
- Вложения сохраняются локально и не передаются третьим лицам

## Устранение неполадок

### Ошибка подключения к IMAP

- Проверьте правильность адреса сервера и порта
- Убедитесь, что используете App Password для Gmail
- Проверьте, что IMAP включен в настройках почтового ящика

### Файлы не обрабатываются

- Убедитесь, что файлы имеют расширение .xls или .xlsx
- Проверьте, что правила парсинга настроены (запустите "Анализ")
- Проверьте логи в консоли браузера и сервера

### Автоматическая проверка не работает

- Убедитесь, что cron job настроен правильно
- Проверьте, что API ключ установлен в переменных окружения
- Проверьте логи сервера на наличие ошибок



