# Руководство по настройке IMAP/POP доступа к почте

## Общая информация

Для работы с email через IMAP/POP вам понадобятся:
1. **IMAP/POP сервер** и порт
2. **Email адрес** и **пароль** (или App Password)
3. **Настройки безопасности** (SSL/TLS)

## Настройка для популярных провайдеров

### Gmail (Google)

#### Шаг 1: Включить IMAP
1. Откройте [настройки Gmail](https://mail.google.com/mail/u/0/#settings/general)
2. Перейдите в "Пересылка и POP/IMAP"
3. Включите "Включить IMAP"
4. Сохраните изменения

#### Шаг 2: Создать App Password
1. Перейдите в [настройки аккаунта Google](https://myaccount.google.com/)
2. Включите **двухфакторную аутентификацию** (если еще не включена)
3. Перейдите в раздел "Безопасность" → "Двухэтапная аутентификация"
4. Прокрутите вниз до "Пароли приложений"
5. Выберите "Почта" и устройство
6. Нажмите "Создать"
7. **Скопируйте 16-значный пароль** (он показывается только один раз!)

#### Шаг 3: Настройки для приложения
- **IMAP сервер**: `imap.gmail.com`
- **Порт**: `993`
- **Безопасное соединение**: Да (SSL/TLS)
- **Email**: ваш полный email адрес (например, `yourname@gmail.com`)
- **Пароль**: используйте **App Password** (16 символов без пробелов), НЕ обычный пароль

---

### Яндекс.Почта

#### Шаг 1: Включить IMAP
1. Откройте [настройки Яндекс.Почты](https://mail.yandex.ru/#setup/client)
2. Включите "Сервер входящей почты IMAP"
3. Сохраните изменения

#### Шаг 2: Создать пароль приложения (опционально, но рекомендуется)
1. Перейдите в [настройки безопасности](https://id.yandex.ru/security)
2. Включите двухфакторную аутентификацию
3. Создайте "Пароль приложения" для "Почта"

#### Шаг 3: Настройки для приложения
- **IMAP сервер**: `imap.yandex.ru`
- **Порт**: `993`
- **Безопасное соединение**: Да (SSL/TLS)
- **Email**: ваш полный email адрес (например, `yourname@yandex.ru`)
- **Пароль**: пароль приложения или обычный пароль (если 2FA не включена)

---

### Mail.ru

#### Шаг 1: Включить IMAP
1. Откройте [настройки Mail.ru](https://e.mail.ru/settings/)
2. Перейдите в "Почтовые программы"
3. Включите IMAP
4. Сохраните изменения

#### Шаг 2: Создать пароль приложения (ОБЯЗАТЕЛЬНО!)

⚠️ **ВАЖНО**: Mail.ru требует использования пароля приложения для внешних приложений. Обычный пароль не работает!

1. Перейдите в [настройки безопасности Mail.ru](https://id.mail.ru/profile/security)
2. Найдите раздел **"Пароли приложений"** или **"Доступ из приложений"**
3. Нажмите **"Создать пароль приложения"** или **"Разрешить доступ"**
4. Выберите тип приложения: **"Почта"** или **"IMAP"**
5. Введите название приложения (например, "Lavsit Textile")
6. Нажмите **"Создать"**
7. **Скопируйте сгенерированный пароль** (он показывается только один раз!)
8. Используйте этот пароль в настройках приложения

**Альтернативный способ:**
1. Откройте [настройки безопасности](https://id.mail.ru/profile/security)
2. Включите **"Доступ из приложений"** или **"Разрешить доступ для небезопасных приложений"**
3. Создайте пароль приложения для почты

#### Шаг 3: Настройки для приложения
- **IMAP сервер**: `imap.mail.ru`
- **Порт**: `993`
- **Безопасное соединение**: Да (SSL/TLS)
- **Email**: ваш полный email адрес (например, `yourname@mail.ru`)
- **Пароль**: **используйте ПАРОЛЬ ПРИЛОЖЕНИЯ**, НЕ обычный пароль от почты

**Примечание**: Без пароля приложения вы получите ошибку "Application password is REQUIRED".

---

### Outlook / Office 365

#### Шаг 1: Проверить настройки
1. Откройте [настройки Outlook](https://outlook.office.com/mail/)
2. Перейдите в "Параметры" → "Почта" → "Синхронизация электронной почты"
3. Убедитесь, что IMAP включен

#### Шаг 2: Настройки для приложения
- **IMAP сервер**: `outlook.office365.com`
- **Порт**: `993`
- **Безопасное соединение**: Да (SSL/TLS)
- **Email**: ваш полный email адрес (например, `yourname@outlook.com` или `yourname@company.com`)
- **Пароль**: ваш пароль от Microsoft аккаунта

**Примечание**: Для корпоративных аккаунтов может потребоваться разрешение администратора.

---

### Другие провайдеры

#### Общие настройки IMAP:
- **Порт 993**: для SSL/TLS (рекомендуется)
- **Порт 143**: для STARTTLS (менее безопасно)
- **Порт 110**: для POP3 (устаревший протокол)

#### Как найти настройки IMAP:
1. Проверьте документацию вашего почтового провайдера
2. Обычно настройки находятся в разделе "Почтовые программы" или "Настройки почты"
3. Ищите раздел "IMAP" или "Настройки для внешних клиентов"

---

## Настройка в приложении Lavsit Textile

### Через интерфейс:

1. Откройте страницу **"Поставщики"**
2. Найдите или создайте поставщика с типом **"email"**
3. Нажмите кнопку **"Настройки Email"**
4. Заполните форму:
   - Выберите провайдера (кнопки быстрой настройки) или введите вручную
   - **IMAP сервер**: адрес сервера
   - **Порт**: обычно 993
   - **Безопасное соединение**: включите для SSL/TLS
   - **Email адрес**: ваш полный email
   - **Пароль**: App Password или обычный пароль
   - **Email отправителя** (опционально): фильтр по адресу
   - **Фильтр по теме** (опционально): фильтр по теме письма
5. Нажмите **"Сохранить"**

### Тестирование подключения:

После сохранения настроек:
1. Нажмите кнопку **"Проверить Email"** для поставщика
2. Система попытается подключиться к почтовому ящику
3. Если подключение успешно, вы увидите количество найденных писем
4. Если есть ошибка, проверьте:
   - Правильность адреса сервера и порта
   - Используете ли вы App Password (для Gmail)
   - Включен ли IMAP в настройках почты
   - Не блокирует ли брандмауэр подключение

---

## Частые проблемы и решения

### Ошибка: "Authentication failed"

**Причины:**
- Неправильный пароль
- Для Gmail используется обычный пароль вместо App Password
- Двухфакторная аутентификация включена, но App Password не создан

**Решение:**
- Для Gmail: создайте App Password и используйте его
- Проверьте правильность пароля
- Убедитесь, что IMAP включен в настройках почты

### Ошибка: "Connection timeout"

**Причины:**
- Неправильный адрес сервера или порт
- Брандмауэр блокирует подключение
- Провайдер требует специальных настроек

**Решение:**
- Проверьте адрес сервера и порт
- Убедитесь, что порт 993 открыт
- Проверьте настройки брандмауэра

### Ошибка: "Certificate verification failed"

**Причины:**
- Проблемы с SSL сертификатом
- Неправильные настройки безопасности

**Решение:**
- Убедитесь, что "Безопасное соединение" включено
- Проверьте настройки SSL/TLS

### Письма не находятся

**Причины:**
- Фильтры слишком строгие
- Письма уже прочитаны (система ищет только непрочитанные)
- Письма старше 7 дней

**Решение:**
- Проверьте фильтры по отправителю и теме
- Убедитесь, что письма непрочитаны
- Проверьте дату писем (система ищет за последние 7 дней)

---

## Безопасность

### Рекомендации:

1. **Используйте App Password** вместо обычного пароля (особенно для Gmail)
2. **Не храните пароли в открытом виде** - используйте переменные окружения для production
3. **Ограничьте доступ** - используйте отдельный email аккаунт только для автоматизации
4. **Регулярно меняйте пароли** - особенно App Passwords
5. **Мониторьте активность** - проверяйте логи доступа к почте

### Для production:

Рекомендуется хранить email credentials в переменных окружения:

```env
EMAIL_HOST=imap.gmail.com
EMAIL_PORT=993
EMAIL_USER=your-email@gmail.com
EMAIL_PASSWORD=your-app-password
```

И использовать их в коде вместо хранения в базе данных.

---

## Дополнительная информация

### IMAP vs POP3

- **IMAP** (рекомендуется):
  - Синхронизирует письма с сервером
  - Позволяет работать с несколькими устройствами
  - Сохраняет структуру папок
  - Требует постоянного подключения

- **POP3** (устаревший):
  - Скачивает письма на устройство
  - Удаляет письма с сервера (обычно)
  - Не синхронизирует между устройствами
  - Менее функционален

**Рекомендация**: Используйте IMAP для всех современных приложений.

### Порт 993 vs 143

- **993 (SSL/TLS)**: 
  - Шифрованное соединение
  - Безопаснее
  - Рекомендуется

- **143 (STARTTLS)**:
  - Соединение начинается незашифрованным
  - Затем переходит на шифрование
  - Менее безопасно

**Рекомендация**: Всегда используйте порт 993 с SSL/TLS.

