# Правила парсинга для всех поставщиков

## Общие принципы

### Структура правил парсинга

Правила парсинга хранятся в базе данных в таблице `ParsingRule` в формате JSON:

```json
{
  "columnMappings": {
    "collection": 2,      // Индекс колонки с коллекцией (0-based)
    "color": 4,          // Индекс колонки с цветом
    "meterage": 6,       // Индекс колонки с метражом
    "inStock": 6,        // Индекс колонки с наличием
    "price": 4,          // Индекс колонки с ценой
    "nextArrivalDate": 9 // Индекс колонки с датой поступления
  },
  "skipRows": [1, 2],    // Номера строк для пропуска (1-based)
  "skipPatterns": ["Сетка"], // Паттерны для пропуска
  "headerRow": 0,        // Номер строки заголовка (0-based)
  "specialRules": {}     // Специальные правила
}
```

### Методы парсинга

1. **HTML** — парсинг HTML таблиц с веб-сайтов
2. **Excel** — парсинг Excel файлов по URL
3. **Email** — получение Excel файлов через email (IMAP)

---

## Аметист

**Метод:** Email (Excel вложения)

### Парсинг тканей (наличие и метраж)

**Структура файла:**
- Колонка C (индекс 2) — коллекция
- Колонка E (индекс 4) — цвет
- Колонка G (индекс 6) — метраж
- Колонка H (индекс 7) — единица измерения "м" (опционально)
- Колонка J (индекс 9) — дата следующего поступления

**Правила парсинга метража:**
1. Значение берется **только** из колонки G (индекс 6)
2. Поддерживаются не целые числа (например, 76,4 или 76.6)
3. Могут быть знаки больше/меньше (например, > 100, < 8)
4. Если число >= 10: `в наличии = true`, метраж = число
5. Если число < 10: `в наличии = true`, метраж = число, комментарий = "ВНИМАНИЕ, МАЛО!"

**Особенности:**
- Файлы могут приходить в формате ZIP, система автоматически распаковывает Excel файл
- Единица измерения "м" может быть в следующей колонке (H) или в той же ячейке
- Если единица измерения в той же ячейке, она удаляется перед парсингом

**Пример строки:**
```
990007507 | Ткань мебельная | BYORK | | BYORK latte | Внедрение | 76,4 | м | Макс.рулон: 36,0
```

**Результат:**
- Коллекция: BYORK
- Цвет: BYORK latte
- Наличие: в наличии
- Метраж: 76.4

### Парсинг прайса

Прайс-листы не парсятся автоматически. Используется ручная загрузка через интерфейс.

---

## NoFrames

**Метод:** Excel по URL

### Парсинг тканей (наличие и метраж)

**Структура файла:**
- Парсятся только вкладки "ОСНОВНЫЕ КОЛЛЕКЦИИ" и "РАСПРОДАЖА"
- Пропускаются первые 6 строк (заголовки)
- Колонка B (индекс 1) — коллекция и цвет (формат: "КОЛЛЕКЦИЯ ЦВЕТ")
- Колонка D (индекс 3) — наличие/метраж
- Колонка E (индекс 4) — дата следующего поступления

**Правила парсинга:**
1. Если значение в колонке D > 0: `в наличии = true`, метраж = значение
2. Если значение = 0 или пусто: `в наличии = false`
3. Игнорируются строки, содержащие только название коллекции (без цвета)

**Особенности:**
- URL содержит timestamp для обхода кэша: `{timestamp}`
- Файлы в старом формате .xls, парсятся через библиотеку `xlsx`

### Парсинг прайса

**Структура прайс-листа:**
- Колонка B (индекс 1) — коллекция
- Колонка E (индекс 4) — цена
- Колонка F (индекс 5) — страна
- Колонка G (индекс 6) — тип ткани
- Колонка H (индекс 7) — состав
- Колонка I (индекс 8) — тест Мартиндейла

**Правила парсинга:**
1. Цена одинакова для всех тканей в коллекции
2. Формат цены: "3 171,00р." (пробелы как разделители тысяч, запятая как десятичный разделитель)
3. Нормализация: "3 171,00р." → 3171.00 ₽
4. Тип ткани (колонка G) присваивается всем тканям в коллекции
5. Описание формируется: "Страна: {F}, Состав: {H}, тест Мартиндейла: {I}"
6. Категория определяется автоматически по цене за метр погонный

**Особенности:**
- После нахождения цены коллекции она применяется ко всем тканям в этой коллекции
- Категория определяется автоматически после установки цены

---

## Эгида

**Метод:** Excel по URL (динамический)

### Парсинг тканей (наличие и метраж)

**Структура файла:**
- Колонка B (индекс 1) — коллекция и цвет
- Колонка C (индекс 2) — наличие
- Колонка D (индекс 3) — комментарий
- Колонка E (индекс 4) — дата следующего поступления

**Правила парсинга коллекции и цвета:**
- Коллекция — текст до первой цифры
- Цвет — цифры + текст после

**Правила парсинга наличия:**
- "Есть в наличии" → `в наличии = true`
- "Мало" → `в наличии = true`, комментарий = "ВНИМАНИЕ, МАЛО!"
- "Нет в наличии" → `в наличии = false`

**Правила парсинга комментария:**
- Если колонка D заполнена, добавляется к комментарию с префиксом "На складе в Казани: {текст}"

**Особенности:**
- URL динамический: `https://exch.tendence.ru/download.php?file={DD.MM.YY}_ostatki_tkani_ooo_egida.xls`
- Система автоматически ищет актуальный файл, проверяя даты от сегодня до 30 дней назад

### Парсинг прайса

Прайс-листы не парсятся автоматически. Используется ручная загрузка через интерфейс.

---

## Нортекс

**Метод:** Email (Excel вложения)

### Парсинг тканей (наличие и метраж)

**Структура файла:**
- Колонка D (индекс 3) — коллекция и цвет (формат: "Ткань {КОЛЛЕКЦИЯ} {ЦВЕТ}")
- Колонка E (индекс 4) — наличие (опционально)
- Колонка F (индекс 5) — наличие < 100м (опционально)
- Колонка G (индекс 6) — наличие > 100м
- Колонка H (индекс 7) — дата следующего поступления

**Правила парсинга:**
1. Префикс "Ткань" автоматически удаляется из колонки D
2. Приоритет наличия:
   - Если значение в колонке G > 100м: `в наличии = true`, метраж = значение из G
   - Если значение в колонке F < 100м: `в наличии = true`, метраж = значение из F
   - Если значение в колонке E: `в наличии = true`, метраж = значение из E

**Особенности:**
- Пропускаются строки с "пог. м", "Ед.изм.", "отчет создан"
- Данные приходят по email в виде Excel вложений

### Парсинг прайса

Прайс-листы не парсятся автоматически. Используется ручная загрузка через интерфейс.

---

## Vektor

**Метод:** Excel по URL (динамический)

### Парсинг тканей (наличие и метраж)

**Структура файла:**
- Колонка D (индекс 3) — коллекция и цвет (формат: "КОЛЛЕКЦИЯ ЦВЕТ")
- Колонка F (индекс 5) — метраж
- Колонка G (индекс 6) — дата следующего поступления

**Правила парсинга:**
1. Если значение в колонке F > 0: `в наличии = true`, метраж = значение
2. Если значение = 0 или пусто: `в наличии = false`
3. Игнорируются строки со словом "Сетка"

**Особенности:**
- URL динамический: `https://api.vektor.club/static/remainders_files/{DDMMYY}_MSK.xlsx`
- Система автоматически ищет актуальный файл

### Парсинг прайса

Прайс-листы не парсятся автоматически. Используется ручная загрузка через интерфейс.

---

## Viptextil

**Метод:** HTML

### Парсинг тканей (наличие и метраж)

**Структура HTML таблицы:**
- Колонка A (индекс 0) — коллекция и цвет (формат: "КОЛЛЕКЦИЯ ЦВЕТ")
- Колонка B (индекс 1) — наличие

**Правила парсинга:**
- "Есть в наличии" → `в наличии = true`
- Другие значения → `в наличии = false`, комментарий = значение из колонки B

**Особенности:**
- Парсинг HTML страницы через Puppeteer (для обхода защиты от ботов)
- Fallback на curl, если Puppeteer не работает

### Парсинг прайса

Прайс-листы не парсятся автоматически. Используется ручная загрузка через интерфейс.

---

## Artefact

**Метод:** Excel по URL

### Парсинг тканей (наличие и метраж)

**Структура файла:**
- Колонка A (индекс 0) — коллекция и цвет (формат: "КОЛЛЕКЦИЯ ЦВЕТ")
- Колонка C (индекс 2) — метраж
- Колонка D (индекс 3) — комментарий
- Колонка F (индекс 5) — дата следующего поступления

**Правила парсинга:**
1. Если значение в колонке C > 0: `в наличии = true`, метраж = значение
2. Если значение < 10: комментарий = "ВНИМАНИЕ, МАЛО!"
3. Если "нет" или пусто: `в наличии = false`

### Парсинг прайса

Прайс-листы не парсятся автоматически. Используется ручная загрузка через интерфейс.

---

## Artvision

**Метод:** HTML

### Парсинг тканей (наличие и метраж)

**Структура HTML таблицы:**
- Колонка A (индекс 0) — коллекция и цвет (разделение по тире: "КОЛЛЕКЦИЯ - ЦВЕТ")
- Колонка B (индекс 1) — наличие
- Колонка C (индекс 2) — метраж

**Особенности:**
- Специальное правило для разделения коллекции и цвета по тире

### Парсинг прайса

Прайс-листы не парсятся автоматически. Используется ручная загрузка через интерфейс.

---

## Союз-М

**Метод:** Excel по URL

### Парсинг тканей (наличие и метраж)

**Структура файла:**
- Колонка B (индекс 1) — коллекция и цвет
- Колонка C (индекс 2) — наличие

### Парсинг прайса

Прайс-листы не парсятся автоматически. Используется ручная загрузка через интерфейс.

---

## Домиарт

**Метод:** Excel по URL

### Парсинг тканей (наличие и метраж)

**Структура файла:**
- Колонка A (индекс 0) — коллекция и цвет
- Специальное правило для коллекции "Alfa 2303"

### Парсинг прайса

Прайс-листы не парсятся автоматически. Используется ручная загрузка через интерфейс.

---

## Артекс

**Метод:** Excel по URL

### Парсинг тканей (наличие и метраж)

**Структура файла:**
- Колонка A (индекс 0) — коллекция и цвет
- Удаляется префикс "Мебельная ткань"

### Парсинг прайса

Прайс-листы не парсятся автоматически. Используется ручная загрузка через интерфейс.

---

## TextileData

**Метод:** HTML

### Парсинг тканей (наличие и метраж)

**Структура HTML таблицы:**
- Колонка A (индекс 0) — коллекция и цвет
- Удаляется "_\" и извлекаются только цифры для цвета

### Парсинг прайса

Прайс-листы не парсятся автоматически. Используется ручная загрузка через интерфейс.

---

## TextileNova

**Метод:** HTML

### Парсинг тканей (наличие и метраж)

**Структура:** Парсинг HTML таблицы с данными о тканях

### Парсинг прайса

Прайс-листы не парсятся автоматически. Используется ручная загрузка через интерфейс.

---

## Tex.Group

**Метод:** Excel по URL

### Парсинг тканей (наличие и метраж)

**Структура:** Парсинг Excel файла с данными о тканях

### Парсинг прайса

Прайс-листы не парсятся автоматически. Используется ручная загрузка через интерфейс.

---

## Общие правила для всех поставщиков

### Нормализация данных

1. **Цены** — нормализуются через `normalizePrice()`:
   - Удаляются пробелы как разделители тысяч
   - Запятая заменяется на точку как десятичный разделитель
   - Пример: "3 171,00р." → 3171.00

2. **Даты** — парсятся через `parseDate()`:
   - Поддерживаются различные форматы дат
   - Валидация через `validateDate()`

3. **Коллекция и цвет** — парсятся через `parseCollectionAndColor()`:
   - Разделение по тире, пробелам или цифрам
   - Удаление префиксов ("Ткань", "Мебельная ткань")

### Исключения из парсинга

Ткани и коллекции могут быть исключены из автоматического парсинга:
- Поле `excludedFromParsing = true` в таблице `Fabric`
- Исключенные ткани не обновляются при парсинге
- Управление исключениями через страницу `/exclusions`

### Ручные загрузки

Ручные загрузки имеют приоритет над автоматическим парсером:
- **Наличие** — ручная загрузка блокирует обновления до изменения данных
- **Прайс** — используется для установки цен и категорий

---

## Обновление правил парсинга

Правила парсинга можно обновить через интерфейс:
1. Перейдите на страницу "Поставщики"
2. Нажмите "Правила" для нужного поставщика
3. Отредактируйте правила и сохраните

Или через анализ структуры данных:
1. Нажмите "Анализ" для поставщика
2. Ответьте на вопросы в диалоговом окне
3. Правила будут автоматически сохранены


