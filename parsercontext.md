# Lavsit Textile - Полное описание проекта

## Общая информация

**Название проекта:** Lavsit Textile  
**Тип проекта:** Система парсинга и управления данными о тканях от различных поставщиков  
**Технологический стек:** Next.js 14, TypeScript, Prisma ORM, SQLite, React  
**Порт разработки:** 4001  
**Расположение репозитория:** `E:\Программы\cursor\repositary\lavsit-textile`

## Назначение проекта

Система для автоматического парсинга, хранения и отображения данных о наличии тканей от различных поставщиков. Поддерживает:
- Парсинг HTML таблиц с веб-сайтов поставщиков
- Парсинг Excel файлов (как с веб-сайтов, так и из email-вложений)
- Автоматическую интеграцию через IMAP для получения данных по email
- Ручную загрузку файлов (наличие и прайс-листы)
- Категоризацию тканей по цене
- Визуализацию палитры цветов тканей
- Управление категориями тканей

## Архитектура базы данных

### Модели Prisma

#### Supplier (Поставщик)
- `id` - уникальный идентификатор
- `name` - название поставщика (уникальное)
- `websiteUrl` - URL веб-сайта
- `parsingMethod` - метод парсинга: "html" | "excel" | "email"
- `parsingUrl` - URL для парсинга (для html/excel)
- `emailConfig` - JSON строка с настройками email (для email-поставщиков)
- `fabricsCount` - количество тканей
- `lastUpdatedAt` - дата последнего обновления
- `status` - статус: "active" | "error"
- `errorMessage` - сообщение об ошибке (если есть)

#### Fabric (Ткань)
- `id` - уникальный идентификатор
- `supplierId` - ID поставщика
- `collection` - название коллекции
- `colorNumber` - номер/название цвета
- `inStock` - наличие (true/false/null)
- `meterage` - метраж (в метрах)
- `price` - цена
- `pricePerMeter` - цена за метр погонный (вычисляется автоматически)
- `category` - категория ткани (1-16, определяется по цене)
- `imageUrl` - URL изображения ткани
- `colorHex` - HEX код доминирующего цвета для палитры
- `nextArrivalDate` - дата следующего поступления
- `comment` - комментарий
- `lastUpdatedAt` - дата последнего обновления

**Индексы:** `supplierId`, `collection`, `lastUpdatedAt`, `category`  
**Уникальность:** `supplierId + collection + colorNumber`

#### ParsingRule (Правила парсинга)
- `id` - уникальный идентификатор
- `supplierId` - ID поставщика (уникальное)
- `rules` - JSON строка с правилами парсинга

#### DataStructure (Структура данных)
- `id` - уникальный идентификатор
- `supplierId` - ID поставщика (уникальное)
- `structure` - JSON строка со снимком структуры данных
- `lastCheckedAt` - дата последней проверки

#### EmailAttachment (Email-вложения)
- `id` - уникальный идентификатор
- `supplierId` - ID поставщика
- `messageId` - ID email сообщения
- `subject` - тема письма
- `fromEmail` - отправитель
- `attachmentName` - имя вложения
- `filePath` - путь к сохраненному файлу
- `processed` - обработано ли вложение
- `processedAt` - дата обработки

**Индексы:** `supplierId`, `messageId`, `processed`

#### FabricCategory (Категория ткани)
- `id` - уникальный идентификатор
- `category` - номер категории (1-16, уникальное)
- `price` - цена категории (уникальная)

**Категории по умолчанию:**
1. 550 руб.
2. 650 руб.
3. 800 руб.
4. 1000 руб.
5. 1250 руб.
6. 1550 руб.
7. 1900 руб.
8. 2300 руб.
9. 2750 руб.
10. 3250 руб.
11. 3800 руб.
12. 4400 руб.
13. 5050 руб.
14. 5750 руб.
15. 6500 руб.
16. 7300 руб.

Категория определяется по цене за метр погонный: если цена <= цене категории, то присваивается эта категория.

#### ManualUpload (Ручная загрузка)
- `id` - уникальный идентификатор
- `supplierId` - ID поставщика
- `type` - тип: "stock" | "price"
- `filePath` - путь к загруженному файлу
- `uploadedAt` - дата загрузки
- `processedAt` - дата обработки
- `isActive` - активна ли ручная загрузка
- `lastParserUpdate` - дата последнего обновления через парсер

**Индексы:** `supplierId`, `type`, `isActive`

## Структура проекта

### Основные директории

```
lavsit-textile/
├── app/                    # Next.js App Router
│   ├── api/               # API endpoints
│   │   ├── categories/    # Управление категориями
│   │   ├── fabrics/       # Управление тканями
│   │   ├── jobs/          # Фоновые задачи
│   │   └── suppliers/     # Управление поставщиками
│   ├── categories/        # Страница категорий
│   ├── fabrics/           # Главная страница (ткани)
│   ├── palette/           # Страница палитры цветов
│   └── suppliers/         # Страница поставщиков
├── components/            # React компоненты
│   ├── ui/               # UI компоненты (Radix UI)
│   ├── EmailSettingsDialog.tsx
│   ├── ManualUploadDialog.tsx
│   └── ParsingRulesDialog.tsx
├── lib/                   # Библиотеки и утилиты
│   ├── email/            # Email парсинг
│   ├── jobs/             # Фоновые задачи
│   ├── parsers/          # Парсеры для поставщиков
│   ├── fabric-categories.ts
│   ├── manual-upload-utils.ts
│   └── prisma.ts
├── prisma/               # Prisma схема и миграции
│   ├── schema.prisma
│   └── dev.db            # SQLite база данных
├── scripts/              # Вспомогательные скрипты
└── docs/                 # Документация
```

## Парсеры

### Базовый класс BaseParser

Все парсеры наследуются от `BaseParser` и реализуют:
- `parse(url: string): Promise<ParsedFabric[]>` - парсинг данных
- `analyze(url: string): Promise<ParsingAnalysis>` - анализ структуры данных

**Методы BaseParser:**
- `saveRules()` - сохранение правил парсинга
- `loadRules()` - загрузка правил парсинга
- `saveDataStructure()` - сохранение структуры данных
- `compareStructure()` - сравнение структуры данных
- `parseCollectionAndColor()` - парсинг коллекции и цвета из текста
- `parseDate()` - парсинг даты
- `parseBoolean()` - парсинг булевого значения
- `parseNumber()` - парсинг числа

### Реализованные парсеры

1. **ArtvisionParser** (`artvision-parser.ts`)
   - Метод: HTML
   - URL: https://artvision-home.ru/leftovers/
   - Особенности: парсинг HTML таблицы, специальное правило для разделения коллекции и цвета по тире

2. **SouzmParser** (`souzm-parser.ts`)
   - Метод: Excel
   - URL: https://www.souz-m.ru/leftovers/?is_load_excel=1
   - Особенности: парсинг Excel файла, колонка B - коллекция+цвет

3. **DomiartParser** (`domiart-parser.ts`)
   - Метод: Excel
   - URL: https://k-domiart.ru/assets/files/instock_moscow.xlsx
   - Особенности: специальное правило для коллекции "Alfa 2303"

4. **ArteksParser** (`arteks-parser.ts`)
   - Метод: HTML/Excel
   - Особенности: удаление префикса "Мебельная ткань"

5. **TextileDataParser** (`textiledata-parser.ts`)
   - Метод: HTML
   - Особенности: удаление "_\" и извлечение только цифр для цвета

6. **NoFramesParser** (`noframes-parser.ts`)
   - Метод: Excel
   - Особенности: парсинг старых .xls файлов через библиотеку `xlsx`, работа с вкладками "ОСНОВНЫЕ КОЛЛЕКЦИИ" и "РАСПРОДАЖА"

7. **EmailExcelParser** (`email-excel-parser.ts`)
   - Метод: Email (Excel вложения)
   - Особенности: парсинг Excel файлов, полученных по email, специальная логика для Nortex и Vektor

### Автоматические правила (auto-rules.ts)

Функция `createAutoRules()` создает правила парсинга для каждого поставщика на основе анализа данных:

- **Artvision**: колонка 0 - коллекция+цвет, колонка 1 - наличие, колонка 2 - метраж
- **Союз-М**: колонка 1 (B) - коллекция+цвет, колонка 2 (C) - наличие
- **Домиарт**: колонка 0 (A) - коллекция+цвет, специальное правило для "Alfa 2303"
- **Артекс**: колонка 0 - коллекция+цвет, удаление "Мебельная ткань"
- **TextileData**: HTML таблица, удаление "_\" и извлечение цифр
- **NoFrames**: колонка 1 (B) - коллекция+цвет, пропуск строк 1-6, headerRow = 6
- **Nortex**: колонка 3 (D) - коллекция+цвет, удаление префикса "Ткань", колонка 6 (G) - наличие (>100м), колонка 5 (F) - наличие (<100м)
- **Vektor**: колонка 3 (D) - коллекция+цвет, колонка 5 (F) - метраж, пропуск "Сетка"

## Email интеграция

### EmailParser (lib/email/email-parser.ts)

Класс для работы с IMAP почтой:

**Методы:**
- `connect()` - подключение к IMAP серверу
- `disconnect()` - отключение
- `fetchNewEmails()` - получение новых писем
- `extractExcelAttachments()` - извлечение Excel вложений
- `saveAttachment()` - сохранение вложения на диск
- `markAsProcessed()` - пометка вложения как обработанного
- `getUnprocessedAttachments()` - получение необработанных вложений
- `validateFile()` - валидация Excel файла (проверка наличия данных)

**Конфигурация EmailConfig:**
- `host` - IMAP хост (например, imap.gmail.com)
- `port` - порт (обычно 993 для SSL)
- `secure` - использовать SSL/TLS
- `user` - имя пользователя
- `password` - пароль (для Gmail/Mail.ru нужен App Password)
- `fromEmail` - фильтр по отправителю
- `subjectFilter` - фильтр по теме
- `searchUnreadOnly` - искать только непрочитанные (по умолчанию false)
- `searchDays` - количество дней для поиска (по умолчанию 90)

### Поддерживаемые почтовые сервисы

1. **Gmail**
   - Host: `imap.gmail.com`
   - Port: `993`
   - Secure: `true`
   - **Важно:** Требуется App Password (не обычный пароль)

2. **Yandex**
   - Host: `imap.yandex.ru`
   - Port: `993`
   - Secure: `true`

3. **Mail.ru**
   - Host: `imap.mail.ru`
   - Port: `993`
   - Secure: `true`
   - **Важно:** Требуется App Password

4. **Outlook**
   - Host: `outlook.office365.com`
   - Port: `993`
   - Secure: `true`

### API endpoints для email

- `POST /api/suppliers/[id]/parse-email` - проверка email и парсинг вложений
- `GET/POST /api/suppliers/[id]/email-config` - получение/сохранение конфигурации email
- `POST /api/jobs/check-emails` - фоновый job для проверки всех email-поставщиков

## Ручные загрузки

### Логика приоритетов

1. **Ручная загрузка наличия** имеет приоритет над парсером
2. Данные из парсера обновляют ручную загрузку только если:
   - Данные изменились (новые ткани, изменилось наличие/метраж)
   - Или нет активной ручной загрузки

3. **Ручная загрузка прайс-листа** используется для:
   - Анализа прайс-листа
   - Соответствия по коллекции и цвету
   - Установки корректных цен

### API endpoints

- `POST /api/suppliers/[id]/manual-upload` - загрузка файла (stock или price)
- Логика в `lib/manual-upload-utils.ts`:
  - `shouldUpdateFromParser()` - проверка необходимости обновления
  - `updateFabricsFromParser()` - обновление тканей с учетом ручных загрузок

## Категории тканей

### Логика категоризации

Категория определяется по цене за метр погонный (`pricePerMeter`):
- `pricePerMeter = price / meterage` (если оба значения есть)
- Категория присваивается по правилу: если `pricePerMeter <= categoryPrice`, то присваивается эта категория
- Если цена больше всех категорий, присваивается максимальная категория (16)

### Утилиты (lib/fabric-categories.ts)

- `DEFAULT_CATEGORIES` - массив категорий по умолчанию
- `getCategoryByPrice()` - определение категории по цене
- `calculatePricePerMeter()` - вычисление цены за метр погонный

### API endpoints

- `GET /api/categories` - получение всех категорий
- `POST /api/categories` - добавление/обновление категории
- `DELETE /api/categories` - удаление категории

### UI страница

- `/categories` - управление категориями (добавление, редактирование, удаление)

## Основные страницы

### 1. Главная страница (`/fabrics`)

Отображает все ткани с колонками:
- Поставщик
- Коллекция
- Цвет
- Наличие
- Метраж
- Цена
- **Цена за мп** (вычисляется автоматически)
- **Категория ткани** (определяется по цене за мп)
- **Изображение** (кнопка "Добавить" если нет изображения)
- Дата поступления
- Комментарий

**Фильтры:**
- "Показывать только ткани в наличии" - переключатель для фильтрации

### 2. Страница поставщиков (`/suppliers`)

Таблица всех поставщиков с действиями:
- **Анализ** - анализ структуры данных (первый раз)
- **Парсинг** - запуск парсинга
- **Настройки Email** - настройка email для email-поставщиков
- **Проверить Email** - проверка email и парсинг вложений
- **Ручная загрузка наличия** - загрузка файла с наличием
- **Ручная загрузка прайс-листа** - загрузка прайс-листа
- **Правила** - просмотр/редактирование правил парсинга
- **Экспорт** - экспорт данных поставщика

### 3. Страница категорий (`/categories`)

Управление категориями тканей:
- Таблица с категориями (номер, цена)
- Добавление новой категории
- Редактирование существующей категории
- Удаление категории

### 4. Страница палитры цветов (`/palette`)

Визуализация тканей в виде цветовых квадратов:
- Отображение всех тканей как цветовых квадратов
- При наведении - tooltip с информацией (поставщик, коллекция, цвет, категория, стоимость)
- При клике - показ 2 предыдущих и 2 последующих тканей в палитре
- Фильтр "Показывать только ткани в наличии"

## API Endpoints

### Fabrics (Ткани)
- `GET /api/fabrics` - получение всех тканей (с вычислением pricePerMeter и category)
- `POST /api/fabrics/upload-image` - загрузка изображения ткани

### Suppliers (Поставщики)
- `GET /api/suppliers` - получение всех поставщиков
- `GET /api/suppliers/[id]` - получение поставщика
- `POST /api/suppliers/[id]/parse` - парсинг поставщика
- `POST /api/suppliers/[id]/analyze` - анализ структуры данных
- `GET /api/suppliers/[id]/rules` - получение правил парсинга
- `POST /api/suppliers/[id]/rules` - сохранение правил парсинга
- `GET/POST /api/suppliers/[id]/email-config` - конфигурация email
- `POST /api/suppliers/[id]/parse-email` - проверка email и парсинг
- `POST /api/suppliers/[id]/manual-upload` - ручная загрузка файла
- `GET /api/suppliers/[id]/export` - экспорт данных поставщика

### Categories (Категории)
- `GET /api/categories` - получение всех категорий
- `POST /api/categories` - добавление/обновление категории
- `DELETE /api/categories` - удаление категории

### Jobs (Фоновые задачи)
- `POST /api/jobs/check-emails` - проверка email для всех email-поставщиков

## Зависимости проекта

### Основные зависимости
- `next` (^14.2.30) - Next.js фреймворк
- `react` (^18.3.1) - React библиотека
- `@prisma/client` (^5.22.0) - Prisma ORM клиент
- `prisma` (^5.22.0) - Prisma CLI
- `typescript` (^5.5.4) - TypeScript
- `tailwindcss` (^3.4.13) - Tailwind CSS

### Парсинг и обработка данных
- `cheerio` (^1.0.0) - HTML парсинг
- `xlsx` (^0.18.5) - Excel парсинг (SheetJS, поддерживает .xls и .xlsx)
- `exceljs` (^4.4.0) - Excel обработка (альтернатива)
- `axios` (^1.7.7) - HTTP клиент

### Email интеграция
- `imap` (^0.8.19) - IMAP клиент
- `mailparser` (^3.6.5) - Парсинг email сообщений
- `@types/imap` (^0.8.40) - TypeScript типы для IMAP
- `@types/mailparser` (^3.4.4) - TypeScript типы для mailparser

### UI компоненты (Radix UI)
- `@radix-ui/react-dialog` - Диалоги
- `@radix-ui/react-label` - Лейблы
- `@radix-ui/react-select` - Селекты
- `@radix-ui/react-switch` - Переключатели
- `@radix-ui/react-tabs` - Вкладки
- `@radix-ui/react-toast` - Уведомления

### Утилиты
- `date-fns` (^3.6.0) - Работа с датами
- `lucide-react` (^0.454.0) - Иконки
- `zod` (^3.23.8) - Валидация схем
- `clsx` (^2.1.1) - Условные классы
- `tailwind-merge` (^2.5.4) - Слияние Tailwind классов

## Скрипты package.json

- `dev` - запуск dev сервера на порту 4001
- `build` - сборка production версии
- `start` - запуск production сервера на порту 4001
- `db:generate` - генерация Prisma Client
- `db:push` - применение изменений схемы к БД
- `db:studio` - запуск Prisma Studio
- `db:init` - инициализация поставщиков
- `test:noframes` - тест парсера NoFrames
- `test:noframes-data` - тест данных NoFrames
- `test:noframes-full` - полный тест NoFrames

## Важные особенности

### 1. Парсинг Excel файлов

Используется библиотека `xlsx` (SheetJS) для поддержки как старых `.xls`, так и новых `.xlsx` форматов. Ранее использовался `ExcelJS`, но он не поддерживал старые форматы.

### 2. Email парсинг

- По умолчанию ищет письма за последние 90 дней
- Ищет все письма (включая прочитанные), если не указано иное
- Валидирует Excel вложения перед обработкой
- Выбирает письмо с самой поздней датой, содержащее валидное Excel вложение

### 3. Ручные загрузки

- Ручная загрузка наличия блокирует обновления из парсера до тех пор, пока данные не изменятся
- Ручная загрузка прайс-листа используется для анализа и установки цен

### 4. Категоризация

- Автоматическая категоризация на основе цены за метр погонный
- Категории можно редактировать через UI
- Если категорий нет в БД, используются значения по умолчанию

### 5. Изображения тканей

- Изображения сохраняются в `public/images/fabrics/{supplierId}/`
- Можно загружать вручную через UI
- В будущем планируется парсинг изображений с сайтов поставщиков

### 6. Палитра цветов

- Отображение тканей как цветовых квадратов
- При клике показываются соседние ткани в палитре
- Фильтрация по наличию

## Типичные проблемы и решения

### 1. Prisma Client не синхронизирован

**Проблема:** После изменения `schema.prisma` возникает ошибка "Unknown argument"  
**Решение:** 
```bash
npm run db:generate
# или использовать скрипт
regenerate-prisma.bat
```

### 2. Email ошибки "Invalid credentials"

**Проблема:** Gmail/Mail.ru требуют App Password  
**Решение:** Создать App Password в настройках почты и использовать его вместо обычного пароля

### 3. Excel файлы не парсятся

**Проблема:** Старые .xls файлы не распознаются  
**Решение:** Используется библиотека `xlsx`, которая поддерживает оба формата

### 4. Email не находит письма

**Проблема:** По умолчанию ищет только непрочитанные  
**Решение:** В настройках email установить `searchUnreadOnly: false` и увеличить `searchDays`

## Документация

В папке `docs/` находятся:
- `EMAIL_INTEGRATION.md` - архитектура email интеграции
- `IMAP_SETUP_GUIDE.md` - настройка IMAP для разных почтовых сервисов
- `EMAIL_FORWARDING_SETUP.md` - настройка пересылки писем
- `EMAIL_ERRORS_TROUBLESHOOTING.md` - решение проблем с email

## Будущие улучшения

1. Парсинг изображений тканей с сайтов поставщиков
2. Автоматическое определение доминирующего цвета для палитры
3. Ранжирование тканей в палитре по цвету
4. Расширенная аналитика и отчеты
5. Уведомления об изменениях наличия
6. Интеграция с другими поставщиками

## Контакты и поддержка

Проект находится в активной разработке. При возникновении проблем проверьте:
1. Логи в консоли браузера и сервера
2. Состояние базы данных через Prisma Studio (`npm run db:studio`)
3. Документацию в папке `docs/`


